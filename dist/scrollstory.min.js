/*! ScrollStory - v0.1.0 - 2014-04-04
* https://github.com/sjwilliams/scrollstory
* Copyright (c) 2014 Josh Williams; Licensed MIT */
!function(a,b,c){"use strict";a.widget("sjw.ScrollStory",{options:{content:null,contentSelector:".story",keyboard:!0,scrollOffset:0,triggerOffset:0,preOffsetActivation:!0,autoActivateFirst:!0,delayFirstActivationToOffset:!0,updateOffsetsOnResize:!0,speed:800,scrollRate:"dynamic",easing:"swing",checkViewportVisibility:!1,throttleType:"debounce",scrollSensitivity:100,throttleTypeOptions:null,verboseItemClasses:!1,active:function(){},inactive:function(){},indexchange:function(){},itemblur:function(){},itemfilter:function(){},itemunfilter:function(){},enterviewport:function(){},exitviewport:function(){},categorychange:function(){},itembuild:function(){},offsetschange:function(){},scoll:function(){},resize:function(){},aboveoffset:function(){},belowoffset:function(){}},_create:function(){var d=this;this.$element=a(this.element).addClass("scrollStoryContainer");var e=this.options.content;this.$triggerPoint=a('<div class="photoStory-triggerpoint"></div>').css({display:"none",position:"fixed",width:"100%",height:"1px",top:this.options.triggerOffset+"px",left:"0px",backgroundColor:"#ff0000",zIndex:10}).prependTo(this.$element),this._items=[],this._itemsById={},this._categories=[],this._tags=[],this._activeIndex=0,this._isActive=!1,this._viewport={},this._updateViewport(),a.isArray(e)?this.addItems(e):this._prepItemsFromDom(e,this.options.contentSelector),this._categories=_.uniq(this._categories),this._tags=_.uniq(_.flatten(this._tags)),this._onReady(),this.options.autoActivateFirst&&_.defer(function(){d.focus(d.getItemByIndex(0).id)}),this._on(this.element,{scrollstoryactive:function(){this.element.addClass("scrollStory_active")},scrollstoryinactive:function(){this.element.removeClass("scrollStory_active")}}),this.options.keyboard&&a(c).keydown(_.bind(function(a){var b=!0;switch(a.keyCode){case 37:d.previous();break;case 39:d.next();break;default:b=!1}return!b},this)),this.options.checkViewportVisibility&&this._checkViewportVisibility(),a(b).resize(_.debounce(_.bind(function(){this.onResize()},this),300));var f="throttle"===this.options.throttleType?_.throttle:_.debounce;a(b,"body").scroll(f(_.bind(function(){this.onScroll()},this),d.options.scrollSensitivity,d.options.throttleTypeOptions))},_updateViewport:function(){var a=this.window,b={top:a.scrollTop(),left:a.scrollLeft()};b.right=b.left+a.width(),b.bottom=b.top+a.height(),this._viewport=b},applyToAllItems:function(a,b){b=_.isArray(b)?b:[b];for(var c=0;c<this._items.length;c++){var d=this._items[c];_.contains(b,d.id)||a(d.id)}},blurAll:function(a){this.applyToAllItems(_.bind(this.blur,this),a)},blur:function(a){if(a="string"==typeof a?this.getItemById(a):a,a.active){var b=a.el;b.removeClass("active"),a.active=!1,this._trigger("itemblur",null,{item:a})}},focus:function(a){if(a="string"==typeof a?this.getItemById(a):a,!a.active&&!a.filtered){var b=a.el,c=this._activeIndex;this.blurAll(),this._activeIndex=a.index,a.active=!0,b.addClass("active");var d=this.getItemByIndex(c);this._trigger("indexchange",null,{item:a,index:a.index,id:a.id,previousItem:d,previousIndex:d.index,previousId:d.id}),this.options.verboseItemClasses&&this._verboseItemClasses(),a.category===d.category&&this._isActive||this._trigger("categorychange",null,{category:a.category,previousCategory:d.category}),this._isActive||(this._isActive=!0,this._trigger("active"))}},index:function(a){return"number"==typeof a&&this.getItemByIndex(a)?void this.scrollToItem(this.getItemByIndex(a).id):this.getItemById(this.getTopItemId()).index},next:function(){this.index(this.index()+1)},previous:function(){this.index(this.index()-1)},isActive:function(){return this._isActive},getTopItem:function(){var a=this.getTopItemId();return a?this.getItemById(a):!1},getTopItemId:function(c){c=a.extend(!0,{offset:a(b).scrollTop()+this.options.triggerOffset},c);var d=[];_.each(this._items,function(a){var b=a.triggerOffset?a.triggerOffset:0;a.distanceToOffset=a.topOffset-c.offset-b,a.filtered||d.push({id:a.id,difference:a.distanceToOffset,absoluteDifference:Math.abs(a.distanceToOffset)})});var e;if(this.options.preOffsetActivation)e=_.min(d,function(a){return a.absoluteDifference});else{var f=_.filter(this.getUnfilteredItems(),function(a){return a.distanceToOffset<=0});e=_.max(f,function(a){return a.distanceToOffset})}return e?e.id:!1},getNextItem:function(){var a=this.getTopItem();return a&&a.index<this._items.length?this.getItemByIndex(a.index+1):!1},getPreviousItem:function(){var a=this.getTopItem();return a&&a.index>0?this.getItemByIndex(a.index-1):!1},scrollToItem:function(b,c,d){var e=this,f=this.getItemById(b);c=a.extend(!0,{easing:this.options.easing,speed:this.options.speed,scrollOffset:"number"==typeof f.scrollOffset?f.scrollOffset:this.options.scrollOffset},c),d=_.isFunction(d)?d:function(){},f&&!function(){var b,g,h,i,j,k=f.el.offset().top-c.scrollOffset;"fixed"===e.options.scrollRate?b=c.speed:(g=Math.abs(k-Math.abs(a("html,body").offset().top)),h=_.pluck(e._items,"topOffset"),i=_.reduce(h,function(a,b){return a+b},0)/h.length,j=g/i,b=j*c.speed),a("html, body").stop(!0).animate({scrollTop:k},b,c.easing,_.bind(function(){d()},this))}()},scrollToIndex:function(a,b,c){var d=this.getItemByIndex(a);d&&this.scrollToItem(d.id,b,c)},onResize:function(){this._updateViewport(),this.options.updateOffsetsOnResize&&this.updateOffsets(),this._trigger("resize")},onScroll:function(){var a,b=this.getTopItemId(),c=!1;if(this._updateViewport(),b){a=this.getItemById(b);var d=!0;0===a.index&&a.distanceToOffset>0&&(this.options.preOffsetActivation||(d=!1),this.options.preOffsetActivation&&!this.options.autoActivateFirst&&(d=!1)),d?this.focus(b):(this.blurAll(),c=!0),this._trigger(0===a.index&&a.distanceToOffset>0?"aboveoffset":"belowoffset")}else c=!0;this._trigger("scroll",null,{item:a}),c&&this._isActive&&(this.blurAll(),this._isActive=!1,this._trigger("inactive")),this.options.checkViewportVisibility&&this._checkViewportVisibility()},_verboseItemClasses:function(){var a=this.getTopItem();if(a){var b=a.index;this.$element.find(this.options.contentSelector).removeClass(function(a,b){var c=/order[-0-9]+/.exec(b);return c?c[0]:""}),_.each(this.getItems(),function(a){var c="order"+(a.index-b);a.el.addClass(c)})}},_checkViewportVisibility:function(){_.each(this.getItems(),_.bind(function(a){var b=this._isElementInViewport(a.el);b&&!a.inViewport?(a.el.addClass("inViewport"),a.inViewport=!0,this._trigger("enterviewport",null,{item:a})):!b&&a.inViewport&&(a.el.removeClass("inViewport"),a.inViewport=!1,this._trigger("exitviewport",null,{item:a}))},this))},_isElementFullyInViewport:function(d){d=d instanceof a?d[0]:d;var e=d.getBoundingClientRect();return e.top>=0&&e.left>=0&&e.bottom<=(b.innerHeight||c.documentElement.clientHeight)&&e.right<=(b.innerWidth||c.documentElement.clientWidth)},_isElementInViewport:function(b){b=b instanceof a?b:a(b);var c=this._viewport,d=b.offset();return d.right=d.left+b.outerWidth(),d.bottom=d.top+b.outerHeight(),!(c.right<d.left||c.left>d.right||c.bottom<d.top||c.top>d.bottom)},getLength:function(){return this.getItems().length},getItems:function(){return this._items},getItemById:function(a){var b=this._itemsById[a];return b?this._items[b.index]:!1},getItemByIndex:function(a){return a>=0&&a<this._items.length?this._items[a]:!1},getItemsInViewport:function(){return this.options.checkViewportVisibility||this._checkViewportVisibility(),_.filter(this.getItems(),function(a){return a.inViewport})},getItemsByCategory:function(a){return _.filter(this._items,function(b){return b.category===a})},getUnfilteredItems:function(){return this.getItemsBy(function(a){return!a.filtered})},getFilteredItems:function(){return this.getItemsBy(function(a){return a.filtered})},getCategoryIds:function(){return this._categories},getActiveCategory:function(){return this.getItemByIndex(this.index()).category},scrollToCategory:function(a){var b=this.getItemsByCategory(a)[0];b&&this.scrollToItem(b.id)},scrollToCategoryIndex:function(a){this.scrollToCategory(this._categories[a])},getTags:function(){return this._tags},getItemsByTag:function(a,b){a=_.isArray(a)?a:[a];var c=b?_.every:_.some;return _.filter(this._items,function(b){return c(a,function(a){return _.indexOf(b.tags,a)>-1})})},getItemsBy:function(a){if("function"!=typeof a)throw new Error("You must provide a truthTest function");return _.filter(this._items,function(b){return a(b)})},filterBy:function(a,b){_.each(this.getItemsBy(a),_.bind(function(a){this.filter(a)},this)),"function"==typeof b&&b()},filter:function(a){a="string"==typeof a?this.getItemById(a):a,a&&!a.filtered&&(a.filtered=!0,a.el.addClass("filtered"),this._trigger("itemfilter",null,{item:a}))},unfilter:function(a){a="string"==typeof a?this.getItemById(a):a,a&&a.filtered&&(a.filtered=!1,a.el.removeClass("filtered"),this._trigger("itemunfilter",null,{item:a}))},filterByTag:function(a,b){_.each(this.getItemsByTag(a,b),_.bind(function(a){this.filter(a)},this))},unfilterByTag:function(a,b){_.each(this.getItemsByTag(a),_.bind(function(a){this.unfilter(a,b)},this))},unfilterAllItems:function(){_.each(this.getItems(),_.bind(function(a){this.unfilter(a)},this))},updateOffsets:function(){var b,c=this._items,d=0,e=c.length;for(d=0;e>d;d++)b=c[d],b.el=a("#"+b.id),b.topOffset=b.el.offset().top,b.width=b.el.width(),b.height=b.el.height();this._trigger("offsetschange",null,{}),this.options.checkViewportVisibility&&this._checkViewportVisibility()},destroy:function(){},_setOption:function(a,b){this._super("_setOption",a,b)},addItem:function(b,c){var d=this;c=a.extend(!0,{appendToDom:!0,updateOffsets:!0},c);var e=this._items,f=a("<div></div>"),g=e.length,h=this._prepItem(f,g,b);return c.appendToDom&&this.$element.append(h.el),c.updateOffsets&&_.defer(function(){d.updateOffsets()}),h},addItems:function(b){var c=this,d=a("<div></div>");_.each(b,function(a){var b=c.addItem(a,{appendToDom:!1,updateOffsets:!1});d.append(b.el)}),this.$element.append(d.html()),_.defer(function(){c.updateOffsets()})},enableDebug:function(){this.$triggerPoint.show()},disableDebug:function(){this.$triggerPoint.hide()},_prepItemsFromDom:function(b,c){var d,e=this;d=b?a(b):this.$element.find(c),d.each(function(b){e._prepItem(a(this),b,a(this).data())})},_prepItem:function(a,b,c){var d,e,f=this,g=this._items,h=a.addClass("storyScroll_story"),i=b>0?g[b-1]:!1;return h.attr("id")?d=h.attr("id"):(d="scrollStory_story_"+b,h.attr("id",d)),c.id=d,e={index:b,id:d,domData:c,category:c.category,tags:c.tags||[],el:h,width:h.width(),height:h.height(),previousItem:i,nextItem:!1,active:!1,filtered:!1,topOffset:h.offset().top,scrollOffset:!1,triggerOffset:!1,inViewport:!1},"string"==typeof e.tags&&(e.tags=e.tags.split(",")),f._items.push(e),f._itemsById[d]={index:b,id:d},i&&(i.nextItem=e),f._trigger("itembuild",null,{item:e}),e.category&&this._categories.push(e.category),this._tags.push(e.tags),e},_onReady:function(){var a=this;this._trigger("complete",null,{scrollStory:a})}})}(jQuery,window,document);